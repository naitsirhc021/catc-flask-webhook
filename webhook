from flask import Flask, request, jsonify
import json
import requests
import urllib3
import xmltodict
import re

# Disable SSL warnings for self-signed certificates
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

app = Flask(__name__)

# ISE Configuration
ISE_HOST = "192.168.101.3"
ISE_USERNAME = "admin"  # Replace with your ISE admin username
ISE_PASSWORD = "S1ngt3l@ISE"  # Replace with your ISE admin password

# Deskey API Configuration
DESKEY_API_URL = "https://deskey.optusdart.com/api/deskey/singtel/cisco/webhook"
DESKEY_API_KEY = "QIYGBFDSJKL"
DESKEY_API_SECRET = "fGHji9-2KiOPs5-DfjHGf3"

def query_ise_session(device_ip):
    """
    Query ISE for session information based on device IP address
    """
    url = f"https://{ISE_HOST}/admin/API/mnt/Session/IPAddress/{device_ip}"
    
    headers = {
        "Accept": "application/xml",
        "Content-Type": "application/xml"
    }
    
    try:
        response = requests.get(
            url,
            auth=(ISE_USERNAME, ISE_PASSWORD),
            headers=headers,
            verify=False
        )
        response.raise_for_status()
        
        # Convert XML response to dictionary for easier handling
        xml_data = response.text
        dict_data = xmltodict.parse(xml_data)
        return dict_data
        
    except requests.exceptions.HTTPError as e:
        print(f"HTTP Error querying ISE: {e}")
        print(f"Status Code: {e.response.status_code if e.response else 'Unknown'}")
        print(f"Response: {e.response.text if e.response else 'No response'}")
        return None
    except Exception as e:
        print(f"Error querying ISE session: {e}")
        return None

def format_interface_name(interface_name):
    """
    Format interface name to shorten GigabitEthernet to Gi
    Example: GigabitEthernet1/0/1 -> Gi1/0/1
    """
    if not interface_name or interface_name == 'N/A':
        return interface_name
    
    # Replace GigabitEthernet with Gi using string replace
    if interface_name.startswith('GigabitEthernet'):
        interface_name = interface_name.replace('GigabitEthernet', 'Gi', 1)
    
    return interface_name

def extract_session_info(ise_data):
    """
    Extract nas_port_id, network_device_name, and user_name from ISE session data
    """
    sessions = []
    
    try:
        # Navigate to the session data - structure may vary
        # Common paths: sessionParameters or sessions
        if 'sessionParameters' in ise_data:
            session_list = ise_data['sessionParameters']
            
            # Handle single session or multiple sessions
            if isinstance(session_list, dict):
                session_list = [session_list]
            elif isinstance(session_list, list):
                pass
            else:
                return sessions
                
            for session in session_list:
                nas_port_id = session.get('nas_port_id', 'N/A')
                network_device_name = session.get('network_device_name', 'N/A')
                user_name = session.get('user_name', 'N/A')
                
                # Format the nas_port_id
                formatted_nas_port_id = format_interface_name(nas_port_id)
                
                # Create merged switchPortId variable
                switch_port_id = f"{network_device_name}_{formatted_nas_port_id}"
                
                sessions.append({
                    'nas_port_id': formatted_nas_port_id,
                    'network_device_name': network_device_name,
                    'user_name': user_name,
                    'switch_port_id': switch_port_id
                })
        
    except Exception as e:
        print(f"Error extracting session info: {e}")
    
    return sessions

def call_deskey_api(username, switch_port_id):
    """
    Call the Deskey API with username and switchPortId
    """
    headers = {
        "Content-Type": "application/json",
        "x-ds-api-key": DESKEY_API_KEY,
        "x-ds-api-secret": DESKEY_API_SECRET
    }
    
    payload = {
        "username": username,
        "switchPortId": switch_port_id
    }
    
    try:
        print(f"\nCalling Deskey API...")
        print(f"URL: {DESKEY_API_URL}")
        print(f"Payload: {json.dumps(payload, indent=2)}")
        
        response = requests.post(
            DESKEY_API_URL,
            headers=headers,
            json=payload,
            verify=False,
            timeout=30
        )
        response.raise_for_status()
        
        print(f"\n✓ Deskey API call succeeded!")
        print(f"Response Status: {response.status_code}")
        print(f"Response Content Type: {response.headers.get('Content-Type', 'Unknown')}")
        print(f"Response Text: {response.text}")
        print("=" * 80)
        
        # Handle empty or non-JSON responses
        if response.text and response.text.strip():
            try:
                return response.json()
            except json.JSONDecodeError:
                print("Response is not valid JSON, returning raw text")
                return {"status": "success", "response": response.text}
        else:
            return {"status": "success", "message": "Empty response from API"}
        
    except requests.exceptions.HTTPError as e:
        print(f"HTTP Error calling Deskey API: {e}")
        print(f"Status Code: {e.response.status_code if e.response else 'Unknown'}")
        print(f"Response: {e.response.text if e.response else 'No response'}")
        return {"status": "error", "message": str(e)}
    except Exception as e:
        print(f"Error calling Deskey API: {e}")
        return {"status": "error", "message": str(e)}

@app.route('/webhook', methods=['POST'])
def webhook_receiver():
    # Get JSON payload from Catalyst Center webhook
    data = request.get_json()
    if not data:
        return jsonify({"error": "Invalid or missing JSON payload"}), 400

    # 1. Print the webhook (prettified)
    print("=" * 80)
    print("Received webhook data (prettified):")
    print(json.dumps(data, indent=4, sort_keys=True))
    print("=" * 80)

    # 2. Get "Assurance Issue Details" and "Device" from "details"
    if 'details' in data:
        details = data['details']
        
        assurance_issue_details = details.get('Assurance Issue Details', None)
        device = details.get('Device', None)
        
        if assurance_issue_details:
            print(f"\nAssurance Issue Details: {assurance_issue_details}")
        else:
            print("\nAssurance Issue Details: Not found")
            
        if device:
            print(f"Device: {device}\n")
            
            # Add 1 minute delay before querying ISE
            print("Waiting 1 minute before querying ISE...")
            time.sleep(60)  # 60 seconds = 1 minute
            print("Delay complete. Proceeding with ISE query.\n")
            
            # Query ISE API with the device IP
            print(f"Querying ISE for session information on device: {device}")
            ise_session_data = query_ise_session(device)
            
            if ise_session_data:
                # Indicate success
                print("\n✓ ISE API Request Succeeded!")
                print("=" * 80)
                
                # Extract specific fields
                sessions = extract_session_info(ise_session_data)
                
                if sessions:
                    # Only process the first session (not looping through all)
                    session = sessions[0]
                    
                    print(f"\nSession Information:")
                    print(f"nas_port_id: {session['nas_port_id']}")
                    print(f"network_device_name: {session['network_device_name']}")
                    print(f"user_name: {session['user_name']}")
                    print(f"switch_port_id: {session['switch_port_id']}")
                    print(f"\nUser \"{session['user_name']}\" has connected \"{session['network_device_name']}_{session['nas_port_id']}\"")
                    print("-" * 80)
                    
                    # Call Deskey API once for the first session
                    deskey_response = call_deskey_api(
                        session['user_name'],
                        session['switch_port_id']
                    )
                    
                    # Return response
                    return jsonify({
                        "status": "Webhook received, ISE query succeeded, and Deskey API called",
                        "assurance_issue_details": assurance_issue_details,
                        "device": device,
                        "session": session,
                        "deskey_api_response": deskey_response
                    }), 200
                else:
                    print("No session information found in ISE response")
                    return jsonify({
                        "status": "Webhook received",
                        "assurance_issue_details": assurance_issue_details,
                        "device": device,
                        "error": "No session information found"
                    }), 200
            else:
                print("Failed to retrieve ISE session data")
                return jsonify({
                    "status": "Webhook received",
                    "assurance_issue_details": assurance_issue_details,
                    "device": device,
                    "error": "Failed to retrieve ISE session data"
                }), 500
        else:
            print("Device: Not found\n")
            return jsonify({
                "status": "Webhook received",
                "assurance_issue_details": assurance_issue_details,
                "error": "Device field not found"
            }), 200
    else:
        print("\n'details' field not found in webhook data\n")
        return jsonify({
            "status": "Webhook received",
            "error": "'details' field not found"
        }), 200

if __name__ == '__main__':
    # Run the Flask server with HTTPS using adhoc SSL (self-signed certificate)
    app.run(host='0.0.0.0', port=5000, ssl_context='adhoc')
