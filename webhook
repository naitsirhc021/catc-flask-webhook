from flask import Flask, request, jsonify
import json
import requests
import urllib3
import xmltodict

# Disable SSL warnings for self-signed certificates
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

app = Flask(__name__)

# ISE Configuration
ISE_HOST = "192.168.101.3"
ISE_USERNAME = "your_ise_username"  # Replace with your ISE admin username
ISE_PASSWORD = "your_ise_password"  # Replace with your ISE admin password

def query_ise_session(device_ip):
    """
    Query ISE for session information based on device IP address
    """
    url = f"https://{ISE_HOST}/admin/API/mnt/Session/IPAddress/{device_ip}"
    
    headers = {
        "Accept": "application/xml",
        "Content-Type": "application/xml"
    }
    
    try:
        response = requests.get(
            url,
            auth=(ISE_USERNAME, ISE_PASSWORD),
            headers=headers,
            verify=False
        )
        response.raise_for_status()
        
        # Convert XML response to dictionary for easier handling
        xml_data = response.text
        dict_data = xmltodict.parse(xml_data)
        return dict_data
        
    except requests.exceptions.HTTPError as e:
        print(f"HTTP Error querying ISE: {e}")
        print(f"Status Code: {e.response.status_code if e.response else 'Unknown'}")
        print(f"Response: {e.response.text if e.response else 'No response'}")
        return None
    except Exception as e:
        print(f"Error querying ISE session: {e}")
        return None

@app.route('/webhook', methods=['POST'])
def webhook_receiver():
    # Get JSON payload from Catalyst Center webhook
    data = request.get_json()
    if not data:
        return jsonify({"error": "Invalid or missing JSON payload"}), 400

    # 1. Print the webhook (prettified)
    print("=" * 80)
    print("Received webhook data (prettified):")
    print(json.dumps(data, indent=4, sort_keys=True))
    print("=" * 80)

    # 2. Get "Assurance Issue Details" and "Device" from "details"
    if 'details' in data:
        details = data['details']
        
        assurance_issue_details = details.get('Assurance Issue Details', None)
        device = details.get('Device', None)
        
        if assurance_issue_details:
            print(f"\nAssurance Issue Details: {assurance_issue_details}")
        else:
            print("\nAssurance Issue Details: Not found")
            
        if device:
            print(f"Device: {device}\n")
            
            # Query ISE API with the device IP
            print(f"Querying ISE for session information on device: {device}")
            ise_session_data = query_ise_session(device)
            
            if ise_session_data:
                print("\nISE Session Data Retrieved (prettified):")
                print(json.dumps(ise_session_data, indent=4, sort_keys=True))
                print("=" * 80)
                
                # Return response with extracted data and ISE session info
                return jsonify({
                    "status": "Webhook received",
                    "assurance_issue_details": assurance_issue_details,
                    "device": device,
                    "ise_session_data": ise_session_data
                }), 200
            else:
                print("Failed to retrieve ISE session data")
                return jsonify({
                    "status": "Webhook received",
                    "assurance_issue_details": assurance_issue_details,
                    "device": device,
                    "error": "Failed to retrieve ISE session data"
                }), 500
        else:
            print("Device: Not found\n")
            return jsonify({
                "status": "Webhook received",
                "assurance_issue_details": assurance_issue_details,
                "error": "Device field not found"
            }), 200
    else:
        print("\n'details' field not found in webhook data\n")
        return jsonify({
            "status": "Webhook received",
            "error": "'details' field not found"
        }), 200

if __name__ == '__main__':
    # Run the Flask server with HTTPS using adhoc SSL (self-signed certificate)
    app.run(host='0.0.0.0', port=5000, ssl_context='adhoc')
