from flask import Flask, request, jsonify
import json

app = Flask(__name__)

@app.route('/webhook', methods=['POST'])
def webhook_receiver():
    # Get JSON payload from Catalyst Center webhook
    data = request.get_json()
    if not data:
        return jsonify({"error": "Invalid or missing JSON payload"}), 400

    # 1. Print the webhook (prettified)
    print("=" * 80)
    print("Received webhook data (prettified):")
    print(json.dumps(data, indent=4, sort_keys=True))
    print("=" * 80)

    # 2. Get "Assurance Issue Details" and "Device" from "details"
    if 'details' in data:
        details = data['details']
        
        assurance_issue_details = details.get('Assurance Issue Details', None)
        device = details.get('Device', None)
        
        if assurance_issue_details:
            print(f"\nAssurance Issue Details: {assurance_issue_details}")
        else:
            print("\nAssurance Issue Details: Not found")
            
        if device:
            print(f"Device: {device}\n")
        else:
            print("Device: Not found\n")
        
        # Return response with extracted data
        return jsonify({
            "status": "Webhook received",
            "assurance_issue_details": assurance_issue_details,
            "device": device
        }), 200
    else:
        print("\n'details' field not found in webhook data\n")
        return jsonify({
            "status": "Webhook received",
            "error": "'details' field not found"
        }), 200

if __name__ == '__main__':
    # Run the Flask server with HTTPS using adhoc SSL (self-signed certificate)
    app.run(host='0.0.0.0', port=5000, ssl_context='adhoc')
